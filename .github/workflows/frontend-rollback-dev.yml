name: Frontend Manual Rollback (Development)

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯é–‹ç™ºç’°å¢ƒã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é…ç½®ç‰©ã‚’æ‰‹å‹•ã§å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™ãŸã‚ã®ã‚‚ã®ã§ã™
on:
  workflow_dispatch:
    inputs:
      version_to_rollback:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹S3ãƒãƒ¼ã‚¸ãƒ§ãƒ³IDï¼ˆç©ºç™½ã®å ´åˆã¯ç›´å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼‰'
        required: false
        type: string
      confirm_rollback:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ŒCONFIRMã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„'
        required: true
        type: string

jobs:
  validate-input:
    runs-on: ubuntu-latest
    steps:
      # ç¢ºèªå…¥åŠ›ãŒæ­£ã—ã„ã‹ã‚’æ¤œè¨¼
      - name: ç¢ºèªå…¥åŠ›ã®æ¤œè¨¼
        if: github.event.inputs.confirm_rollback != 'CONFIRM'
        run: |
          echo "ã‚¨ãƒ©ãƒ¼: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ 'CONFIRM' ã¨å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
          exit 1

  rollback:
    runs-on: ubuntu-latest
    needs: validate-input
    environment: development  # é–‹ç™ºç’°å¢ƒã«å¤‰æ›´
    permissions:
      id-token: write
      contents: read
    
    steps:
      # AWSèªè¨¼æƒ…å ±ã®è¨­å®š
      - name: AWSèªè¨¼æƒ…å ±ã®è¨­å®š
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      # S3ãƒã‚±ãƒƒãƒˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆç‰¹å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³IDãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
      - name: S3ãƒã‚±ãƒƒãƒˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        if: github.event.inputs.version_to_rollback == ''
        run: |
          echo "S3ãƒã‚±ãƒƒãƒˆå†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™..."
          # é–‹ç™ºç’°å¢ƒç”¨ã®S3ãƒã‚±ãƒƒãƒˆåã‚’ä½¿ç”¨
          aws s3api list-object-versions --bucket cicd-sample-frontend-dev --prefix "" --max-items 10 > object_versions.json
          cat object_versions.json
      
      # å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™ï¼ˆç‰¹å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³IDãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
      - name: å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
        if: github.event.inputs.version_to_rollback == ''
        run: |
          echo "å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ã„ã¾ã™..."
          # ãƒã‚±ãƒƒãƒˆå†…ã®ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
          aws s3api list-objects-v2 --bucket cicd-sample-frontend-dev --query 'Contents[].Key' --output text | while read -r key; do
            # ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
            previous_version=$(aws s3api list-object-versions --bucket cicd-sample-frontend-dev --prefix "$key" --query 'Versions[1].VersionId' --output text)
            if [ "$previous_version" != "None" ] && [ ! -z "$previous_version" ]; then
              echo "$key ã‚’ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ $previous_version ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ã„ã¾ã™"
              aws s3api copy-object --bucket cicd-sample-frontend-dev --key "$key" --copy-source "cicd-sample-frontend-dev/$key?versionId=$previous_version"
            else
              echo "$key ã®å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            fi
          done
      
      # ç‰¹å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
      - name: ç‰¹å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if: github.event.inputs.version_to_rollback != ''
        run: |
          echo "ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ github.event.inputs.version_to_rollback }} ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ã„ã¾ã™..."
          # ã“ã“ã§ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³IDãŒå…¨ä½“ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã«é©ç”¨ã•ã‚Œã‚‹ã¨ä»®å®šã—ã¦ã„ã¾ã™
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†æˆ¦ç•¥ã«ã‚ˆã£ã¦ã¯ã€ã“ã®è«–ç†ã‚’èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“
          aws s3api list-objects-v2 --bucket cicd-sample-frontend-dev --query 'Contents[].Key' --output text | while read -r key; do
            echo "$key ã‚’ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ github.event.inputs.version_to_rollback }} ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ã„ã¾ã™"
            aws s3api copy-object --bucket cicd-sample-frontend-dev --key "$key" --copy-source "cicd-sample-frontend-dev/$key?versionId=${{ github.event.inputs.version_to_rollback }}"
          done
      
      # CloudFrontã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
      - name: CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç„¡åŠ¹åŒ–
        run: |
          echo "CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã„ã¾ã™..."
          # é–‹ç™ºç’°å¢ƒç”¨ã®CloudFrontãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³IDã‚’ä½¿ç”¨
          aws cloudfront create-invalidation --distribution-id ${{ secrets.DEV_CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
      
      # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å®Œäº†ã‚µãƒãƒªãƒ¼
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ã‚µãƒãƒªãƒ¼
        run: |
          echo "âœ… é–‹ç™ºç’°å¢ƒãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸ”„ S3ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ ${{ github.event.inputs.version_to_rollback == '' && 'å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³' || github.event.inputs.version_to_rollback }} ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ"
          echo "ğŸ§¹ CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ" 