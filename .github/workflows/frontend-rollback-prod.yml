name: Frontend Manual Rollback (Production)

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æœ¬ç•ªç’°å¢ƒã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é…ç½®ç‰©ã‚’æ‰‹å‹•ã§å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™ãŸã‚ã®ã‚‚ã®ã§ã™
on:
  workflow_dispatch:
    inputs:
      version_to_rollback:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹: v1.2.3ï¼‰'
        required: true
        type: string
      confirm_rollback:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ŒCONFIRMã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„'
        required: true
        type: string

jobs:
  validate-input:
    runs-on: ubuntu-latest
    steps:
      # ç¢ºèªå…¥åŠ›ãŒæ­£ã—ã„ã‹ã‚’æ¤œè¨¼
      - name: ç¢ºèªå…¥åŠ›ã®æ¤œè¨¼
        if: github.event.inputs.confirm_rollback != 'CONFIRM'
        run: |
          echo "ã‚¨ãƒ©ãƒ¼: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ 'CONFIRM' ã¨å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
          exit 1
      
      # ãƒãƒ¼ã‚¸ãƒ§ãƒ³å½¢å¼ã‚’æ¤œè¨¼
      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å½¢å¼ã®æ¤œè¨¼
        run: |
          if ! [[ ${{ github.event.inputs.version_to_rollback }} =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã‚»ãƒžãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å½¢å¼ï¼ˆvX.Y.Zï¼‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
            exit 1
          fi
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œè¨¼å®Œäº†: ${{ github.event.inputs.version_to_rollback }}"

  rollback:
    runs-on: ubuntu-latest
    needs: validate-input
    environment: production
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
    
      # AWSèªè¨¼æƒ…å ±ã®è¨­å®š
      - name: AWSèªè¨¼æƒ…å ±ã®è¨­å®š
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      # åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è¦§è¡¨ç¤º
      - name: åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è¦§è¡¨ç¤º
        run: |
          echo "S3ãƒã‚±ãƒƒãƒˆå†…ã®åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™..."
          aws s3 ls s3://cicd-sample-frontend-prod/ --delimiter "/" | grep -v "current/" | grep -v "backup-" | grep "^.*v[0-9]\.[0-9]\.[0-9].*/$" || echo "æ³¨æ„: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
      
      # æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      - name: æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
        run: |
          VERSION="${{ github.event.inputs.version_to_rollback }}"
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if aws s3 ls "s3://cicd-sample-frontend-prod/$VERSION/" --delimiter "/" 2>/dev/null; then
            echo "æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ $VERSION ã¯å­˜åœ¨ã—ã¾ã™"
            echo "VERSION_EXISTS=true" >> $GITHUB_ENV
          else
            echo "è­¦å‘Š: æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ $VERSION ã¯S3ãƒã‚±ãƒƒãƒˆã«å­˜åœ¨ã—ã¾ã›ã‚“"
            echo "åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã„ãšã‚Œã‹ã‚’é¸æŠžã—ã¦ãã ã•ã„"
            echo "VERSION_EXISTS=false" >> $GITHUB_ENV
            exit 1
          fi
      
      # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡¦ç†ã¯Terraformå‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ä¿æŒ
      - name: ç¾åœ¨ã®currentãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        if: env.VERSION_EXISTS == 'true'
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "ç¾åœ¨ã®currentãƒ•ã‚©ãƒ«ãƒ€ã®çŠ¶æ…‹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™: backup-$TIMESTAMP/"
          
          # currentãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if aws s3 ls "s3://cicd-sample-frontend-prod/current/" --delimiter "/" 2>/dev/null; then
            # currentãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã‚’backupãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼
            aws s3 sync s3://cicd-sample-frontend-prod/current/ s3://cicd-sample-frontend-prod/backup-$TIMESTAMP/ --delete
            echo "backup-$TIMESTAMP/ ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ"
          else
            echo "currentãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi
      
      # Terraformã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
      - name: Setup Terraform
        if: env.VERSION_EXISTS == 'true'
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.4.6
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        if: env.VERSION_EXISTS == 'true'
        run: |
          cd infrastructure/environments/prod
          terraform init

      - name: Create Terraform Variables File for Rollback
        if: env.VERSION_EXISTS == 'true'
        run: |
          cat > infrastructure/environments/prod/deploy.auto.tfvars << EOF
          frontend_version = "${{ github.event.inputs.version_to_rollback }}"
          # ãƒ“ãƒ«ãƒ‰ãƒ‘ã‚¹ã¯ç©ºã®ã¾ã¾ï¼ˆæ—¢å­˜ã®S3å†…ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼‰
          frontend_build_path = ""
          EOF

      - name: Execute Rollback with Terraform
        if: env.VERSION_EXISTS == 'true'
        run: |
          cd infrastructure/environments/prod
          terraform apply -auto-approve
      
      # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å®Œäº†ã‚µãƒžãƒªãƒ¼
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ã‚µãƒžãƒªãƒ¼
        if: env.VERSION_EXISTS == 'true'
        run: |
          echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ðŸ”„ currentãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ãŒãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ github.event.inputs.version_to_rollback }} ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ"
          echo "ðŸ§¹ CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ" 