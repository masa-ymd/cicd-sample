# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœ¬ç•ªç’°å¢ƒç”¨ã®CICDå‡¦ç†ã‚’å®šç¾©ã—ã¾ã™
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æœ¬ç•ªç’°å¢ƒï¼ˆproductionï¼‰å‘ã‘ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ã€ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–ã—ã¾ã™
name: Backend Production Workflow

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ã‚’å®šç¾©
# æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æ‰‹å‹•å®Ÿè¡Œã®ã¿è¨±å¯ï¼ˆã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚’å¼·åˆ¶ï¼‰
on:
  # æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ãƒˆãƒªã‚¬ãƒ¼ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·å…¥åŠ›ãŒå¿…è¦ï¼‰
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (semantic versioning: vX.Y.Z)'
        required: true
        type: string

# å¿…è¦ãªæ¨©é™ã‚’å®šç¾©
permissions:
  contents: write         # ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿æ¨©é™ï¼ˆã‚¿ã‚°ä½œæˆã«å¿…è¦ï¼‰
  id-token: write         # OIDCèªè¨¼ç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆæ¨©é™
  pull-requests: read     # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæ¨©é™

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
env:
  AWS_REGION: ${{ secrets.AWS_REGION }}               # AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_PROD }}  # æœ¬ç•ªç’°å¢ƒç”¨ECRãƒªãƒã‚¸ãƒˆãƒªå

jobs:
  # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ¤œè¨¼ã‚¸ãƒ§ãƒ–
  validate-version:
    runs-on: ubuntu-latest
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—

      # ã‚¹ãƒ†ãƒƒãƒ—2: å…¥åŠ›ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å½¢å¼(vX.Y.Z)ã«å¾“ã£ã¦ã„ã‚‹ã‹æ¤œè¨¼
      - name: Validate semantic version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Validating version: $VERSION"
          
          if ! [[ $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must follow semantic versioning format (vX.Y.Z)"
            exit 1
          fi
          
          echo "Version format is valid."

      # ã‚¹ãƒ†ãƒƒãƒ—3: AWSèªè¨¼æƒ…å ±ã®è¨­å®š
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # ã‚¹ãƒ†ãƒƒãƒ—4: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
      - name: Check if version already exists
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          echo "Checking if backend version $VERSION already exists in ECR..."
          # ECRã§ã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if aws ecr describe-images --repository-name ${{ env.ECR_REPOSITORY }} --image-ids imageTag=$VERSION 2>/dev/null; then
            echo "Error: Version $VERSION already exists in ECR repository"
            exit 1
          fi
          
          # GitHubã‚¿ã‚°ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if git tag | grep -q "^${VERSION}$"; then
            echo "Error: Git tag $VERSION already exists in the repository"
            exit 1
          fi
          
          echo "Version $VERSION is available for use."
      
      # ã‚¹ãƒ†ãƒƒãƒ—5: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å¦¥å½“æ€§æ¤œè¨¼ï¼ˆéå»ã®ãƒªãƒªãƒ¼ã‚¹ã¨æ¯”è¼ƒï¼‰
      - name: Verify version is greater than previous
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          # vX.Y.Zå½¢å¼ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡º
          MAJOR=$(echo $VERSION | sed -E 's/v([0-9]+)\.[0-9]+\.[0-9]+/\1/')
          MINOR=$(echo $VERSION | sed -E 's/v[0-9]+\.([0-9]+)\.[0-9]+/\1/')
          PATCH=$(echo $VERSION | sed -E 's/v[0-9]+\.[0-9]+\.([0-9]+)/\1/')
          
          echo "Version components: Major=$MAJOR, Minor=$MINOR, Patch=$PATCH"
          
          # ECRã‹ã‚‰æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—ã—ã€ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          LATEST_VERSION=$(aws ecr describe-images --repository-name ${{ env.ECR_REPOSITORY }} --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[*]' --output text | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' || echo "v0.0.0")
          
          if [ "$LATEST_VERSION" == "v0.0.0" ]; then
            echo "No previous version found. This will be the first release."
          else
            echo "Latest version: $LATEST_VERSION"
            
            # æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ•°å€¤ã‚’æŠ½å‡º
            LATEST_MAJOR=$(echo $LATEST_VERSION | sed -E 's/v([0-9]+)\.[0-9]+\.[0-9]+/\1/')
            LATEST_MINOR=$(echo $LATEST_VERSION | sed -E 's/v[0-9]+\.([0-9]+)\.[0-9]+/\1/')
            LATEST_PATCH=$(echo $LATEST_VERSION | sed -E 's/v[0-9]+\.[0-9]+\.([0-9]+)/\1/')
            
            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒ
            if [ $MAJOR -lt $LATEST_MAJOR ] || 
               ([ $MAJOR -eq $LATEST_MAJOR ] && [ $MINOR -lt $LATEST_MINOR ]) || 
               ([ $MAJOR -eq $LATEST_MAJOR ] && [ $MINOR -eq $LATEST_MINOR ] && [ $PATCH -le $LATEST_PATCH ]); then
              echo "Error: Version $VERSION is not greater than latest version $LATEST_VERSION"
              exit 1
            fi
          fi
          
          echo "Version validation successful: $VERSION is newer than existing versions."

  # GitHubã‚¿ã‚°ä½œæˆã‚¸ãƒ§ãƒ–: validate-versionã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ãŸã‚‰ã€GitHubãƒªãƒã‚¸ãƒˆãƒªã«ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã™
  create-tag:
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—
      
      # ã‚¹ãƒ†ãƒƒãƒ—2: Gitãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
      - name: Setup git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      # ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¿ã‚°ã®ä½œæˆã¨ãƒ—ãƒƒã‚·ãƒ¥
      - name: Create and push tag
        run: |
          VERSION="${{ github.event.inputs.version }}"
          ANNOTATION="Backend release $VERSION - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          echo "Creating annotated tag $VERSION with message: $ANNOTATION"
          git tag -a "$VERSION" -m "$ANNOTATION"
          git push origin "$VERSION"
          
          echo "Successfully created and pushed tag $VERSION"

  # ãƒ†ã‚¹ãƒˆã¨ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ï¼†ECRã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’è¡Œã„ã¾ã™
  test-and-build:
    runs-on: ubuntu-latest
    needs: create-tag
    environment: production   # GitHub Environmentã§è¨­å®šã—ãŸã€Œproductionã€ç’°å¢ƒã‚’ä½¿ç”¨
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}  # å¾Œç¶šã‚¸ãƒ§ãƒ–ã§åˆ©ç”¨ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã‚’å‡ºåŠ›

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3

      # ã‚¹ãƒ†ãƒƒãƒ—2: Rubyã®å®Ÿè¡Œç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'              # Rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®š
          bundler-cache: true              # Bundlerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–ï¼ˆé«˜é€ŸåŒ–ï¼‰
          working-directory: 'backend'     # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š

      # ã‚¹ãƒ†ãƒƒãƒ—3: Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run tests
        working-directory: backend
        run: |
          bundle exec rspec

      # ã‚¹ãƒ†ãƒƒãƒ—4: AWSèªè¨¼æƒ…å ±ã®è¨­å®šï¼ˆECRã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¿…è¦ï¼‰
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ã‚¹ãƒ†ãƒƒãƒ—5: Amazon ECRã¸ã®ãƒ­ã‚°ã‚¤ãƒ³
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # ã‚¹ãƒ†ãƒƒãƒ—6: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°ã‚’è¨­å®š
      - name: Set image tag
        id: image-tag
        run: |
          # æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¿ã‚°ã¨ã—ã¦ä½¿ç”¨
          TAG="${{ github.event.inputs.version }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT                  # ã‚¿ã‚°ã‚’å‡ºåŠ›å¤‰æ•°ã«è¨­å®š
          echo "ECR_REPOSITORY_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}" >> $GITHUB_ENV  # ECRãƒªãƒã‚¸ãƒˆãƒªURIã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š

      # ã‚¹ãƒ†ãƒƒãƒ—7: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
      - name: Build and push Docker image
        working-directory: backend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .    # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG          # ECRã«ãƒ—ãƒƒã‚·ãƒ¥
          echo "Image pushed to ECR: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

  # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–: ãƒ“ãƒ«ãƒ‰ã—ãŸDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æœ¬ç•ªç’°å¢ƒã®ECSã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™
  deploy:
    runs-on: ubuntu-latest
    needs: test-and-build   # test-and-buildã‚¸ãƒ§ãƒ–ã®å®Œäº†å¾Œã«å®Ÿè¡Œ
    environment: production   # GitHub Environmentã§è¨­å®šã—ãŸã€Œproductionã€ç’°å¢ƒã‚’ä½¿ç”¨

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3

      # ã‚¹ãƒ†ãƒƒãƒ—2: AWSèªè¨¼æƒ…å ±ã®è¨­å®š
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ã‚¹ãƒ†ãƒƒãƒ—3: Amazon ECRã¸ã®ãƒ­ã‚°ã‚¤ãƒ³
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
      - name: Set environment variables
        run: |
          echo "ECR_REPOSITORY_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ needs.test-and-build.outputs.image-tag }}" >> $GITHUB_ENV

      # ã‚¹ãƒ†ãƒƒãƒ—5: ç¾åœ¨ã®ECSã‚¿ã‚¹ã‚¯å®šç¾©ã‚’å–å¾—
      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition cicd-sample-task-prod \
            --query "taskDefinition" \
            --output json > task-definition.json

      # ã‚¹ãƒ†ãƒƒãƒ—6: ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã§æ›´æ–°
      - name: Update task definition with new image
        run: |
          # jqã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°
          jq --arg IMAGE "$ECR_REPOSITORY_URI:$IMAGE_TAG" \
             --arg VERSION "$IMAGE_TAG" \
             '.containerDefinitions[0].image = $IMAGE | .containerDefinitions[0].environment += [{"name": "APP_VERSION", "value": $VERSION}]' \
             task-definition.json > new-task-definition.json
          
          # æ›´æ–°ã—ãŸã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ç™»éŒ²
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)
          
          echo "New task definition registered: $NEW_TASK_DEF_ARN"
          echo "TASK_DEF_ARN=$NEW_TASK_DEF_ARN" >> $GITHUB_ENV

      # ã‚¹ãƒ†ãƒƒãƒ—7: ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°ã—ã¦æ–°ã—ã„ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster cicd-sample-cluster-prod \
            --service cicd-sample-service-prod \
            --task-definition $TASK_DEF_ARN \
            --force-new-deployment

      # ã‚¹ãƒ†ãƒƒãƒ—8: ãƒ‡ãƒ—ãƒ­ã‚¤ã®å®Œäº†ã‚’å¾…æ©Ÿ
      - name: Wait for deployment to complete
        run: |
          aws ecs wait services-stable \
            --cluster cicd-sample-cluster-prod \
            --services cicd-sample-service-prod
            
      # ã‚¹ãƒ†ãƒƒãƒ—9: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
      - name: Deployment completed
        run: |
          echo "ğŸš€ Backend version ${{ env.IMAGE_TAG }} has been successfully deployed to production environment." 