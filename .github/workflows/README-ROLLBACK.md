# フロントエンドロールバックワークフロー

このドキュメントは、GitHub Actionsワークフローを使用してフロントエンドのデプロイメントを手動でロールバックする方法を説明します。

## 概要

ロールバックワークフローは主に3つのアクションを実行します：
1. 現在のcurrentフォルダの内容をバックアップ
2. 指定されたバージョンのフォルダからcurrentフォルダへファイルをコピー
3. CloudFrontキャッシュを無効化し、ロールバックされたバージョンがユーザーに提供されるようにする

## 使用するタイミング

このワークフローは以下の場合に使用してください：
- 本番環境へのデプロイメントで重大なバグが発生した場合
- 以前の正常に動作していたバージョンに素早く戻す必要がある場合
- 通常のデプロイ手順では問題を修正するのに時間がかかりすぎる場合

## 前提条件

- ワークフローをトリガーする権限を持つGitHubアクセス
- フロントエンドアプリケーションがバージョン別ディレクトリとcurrentディレクトリに配置されていること
- S3バケット構造:
  ```
  s3://cicd-sample-frontend-[env]/
    ├── current/           # CloudFrontから参照される現在のアクティブなバージョン
    ├── v1.0.0/            # 本番環境のセマンティックバージョン
    ├── v1.1.0/            # 本番環境の別のバージョン
    ├── abc123-dev/        # 開発環境のバージョン（コミットハッシュ-dev）
    └── backup-20230815-120000/ # バックアップファイル（ロールバック時に自動作成）
  ```

## デプロイ方法の変更が必要な理由

Reactなどのモダンフロントエンドフレームワークでは、ビルド時にJS/CSSファイルにハッシュ値が付与され（例：`main.a1b2c3d4.js`）、ビルドごとにファイル名が変わります。このため、個々のファイルバージョンを使用したロールバックでは正しく動作しないことがあります。

バージョン別ディレクトリ構造とcurrentフォルダを使用することで、各バージョンを完全に分離して管理し、簡単にロールバックできるようになります。currentフォルダをCloudFrontから参照することで、ロールバック時に参照先を変更する必要がありません。

## バージョン命名規則

環境ごとに異なるバージョン命名規則を使用しています：

### 開発環境
- 形式: `[commit-hash]-dev`
- 例: `abc123-dev`

### 本番環境
- 形式: セマンティックバージョニング `vX.Y.Z`
- 例: `v1.2.3`

## ロールバックの実行方法

1. GitHubリポジトリのActionsタブに移動
2. リストから「Frontend Manual Rollback (Production)」または「Frontend Manual Rollback (Development)」ワークフローを選択
3. 「Run workflow」をクリック
4. パラメータを入力：
   - **ロールバックするバージョン**: 環境に合ったバージョン形式を使用
     - 開発環境: `abc123-dev`
     - 本番環境: `v1.2.3`
   - **ロールバック確認**: ロールバックを実行するには「CONFIRM」（大文字）と入力
5. 「Run workflow」をクリックしてロールバックプロセスを開始

## ロールバックの仕組み

1. **バックアップ**: 現在のcurrentフォルダの内容が自動的に`backup-YYYYMMDD-HHMMSS`というタイムスタンプ付きフォルダにバックアップされます
2. **更新**: 指定したバージョンフォルダから新しいcurrentフォルダへファイルがコピーされます
3. **キャッシュ無効化**: CloudFrontキャッシュが無効化され、新しいバージョンがすぐに反映されます

## 利用可能なバージョンの確認方法

ロールバックできるバージョンは、S3バケット内のディレクトリで確認できます：

```bash
# 本番環境（セマンティックバージョンのみ表示）
aws s3 ls s3://cicd-sample-frontend-prod/ --delimiter "/" | grep -v "current/" | grep -v "backup-" | grep "^.*v[0-9]\.[0-9]\.[0-9].*/$"

# 開発環境（コミットハッシュ-devのみ表示）
aws s3 ls s3://cicd-sample-frontend-dev/ --delimiter "/" | grep -v "current/" | grep -v "backup-" | grep "^.*-dev/$"
```

または、ワークフロー実行時に最初のステップで利用可能なバージョンのリストが表示されます。

## トラブルシューティング

- ロールバックが失敗した場合、ワークフローログで具体的なエラーメッセージを確認
- 指定したバージョンが存在しない場合はエラーとなります
- AWS認証情報が正しく設定されていることを確認
- CloudFrontの無効化が失敗した場合は、AWSコンソールで手動で無効化を作成することもできます
- バックアップからの復元が必要な場合は、backup-XXXXXXXフォルダからcurrentフォルダへコピーすることで対応可能 