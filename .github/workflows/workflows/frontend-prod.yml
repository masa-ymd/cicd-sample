name: Frontend Production Workflow

# æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æ‰‹å‹•å®Ÿè¡Œã®ã¿è¨±å¯ï¼ˆã‚»ãƒžãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚’å¼·åˆ¶ï¼‰
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (semantic versioning: vX.Y.Z)'
        required: true
        type: string

# æ¨©é™ã®è¨­å®š
permissions:
  contents: write         # ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿æ¨©é™ï¼ˆã‚¿ã‚°ä½œæˆã«å¿…è¦ï¼‰
  id-token: write         # OIDCèªè¨¼ç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆæ¨©é™ 
  pull-requests: read     # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæ¨©é™

jobs:
  # ã‚»ãƒžãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ¤œè¨¼ã‚¸ãƒ§ãƒ–
  validate-version:
    runs-on: ubuntu-latest
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—

      # ã‚¹ãƒ†ãƒƒãƒ—2: å…¥åŠ›ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒã‚»ãƒžãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å½¢å¼(vX.Y.Z)ã«å¾“ã£ã¦ã„ã‚‹ã‹æ¤œè¨¼
      - name: Validate semantic version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Validating version: $VERSION"
          
          if ! [[ $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must follow semantic versioning format (vX.Y.Z)"
            exit 1
          fi
          
          echo "Version format is valid."

      # ã‚¹ãƒ†ãƒƒãƒ—3: AWSèªè¨¼æƒ…å ±ã®è¨­å®š
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      # ã‚¹ãƒ†ãƒƒãƒ—4: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
      - name: Check if version already exists
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          echo "Checking if frontend version $VERSION already exists..."
          # S3ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          if aws s3 ls s3://cicd-sample-frontend-prod/version-$VERSION.json 2>/dev/null; then
            echo "Error: Version $VERSION already exists in S3 bucket"
            exit 1
          fi
          
          # GitHubã‚¿ã‚°ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if git tag | grep -q "^${VERSION}$"; then
            echo "Error: Git tag $VERSION already exists in the repository"
            exit 1
          fi
          
          echo "Version $VERSION is available for use."
      
      # ã‚¹ãƒ†ãƒƒãƒ—5: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å¦¥å½“æ€§æ¤œè¨¼ï¼ˆéŽåŽ»ã®ãƒªãƒªãƒ¼ã‚¹ã¨æ¯”è¼ƒï¼‰
      - name: Verify version is greater than previous
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          # vX.Y.Zå½¢å¼ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡º
          MAJOR=$(echo $VERSION | sed -E 's/v([0-9]+)\.[0-9]+\.[0-9]+/\1/')
          MINOR=$(echo $VERSION | sed -E 's/v[0-9]+\.([0-9]+)\.[0-9]+/\1/')
          PATCH=$(echo $VERSION | sed -E 's/v[0-9]+\.[0-9]+\.([0-9]+)/\1/')
          
          echo "Version components: Major=$MAJOR, Minor=$MINOR, Patch=$PATCH"
          
          # S3ã‹ã‚‰æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã€æœ€ã‚‚æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º
          LATEST_VERSION=$(aws s3 ls s3://cicd-sample-frontend-prod/ --recursive | grep -E 'version-v[0-9]+\.[0-9]+\.[0-9]+\.json' | sort | tail -1 | sed -E 's/.*version-(v[0-9]+\.[0-9]+\.[0-9]+)\.json/\1/' || echo "v0.0.0")
          
          if [ "$LATEST_VERSION" == "v0.0.0" ]; then
            echo "No previous version found. This will be the first release."
          else
            echo "Latest version: $LATEST_VERSION"
            
            # æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ•°å€¤ã‚’æŠ½å‡º
            LATEST_MAJOR=$(echo $LATEST_VERSION | sed -E 's/v([0-9]+)\.[0-9]+\.[0-9]+/\1/')
            LATEST_MINOR=$(echo $LATEST_VERSION | sed -E 's/v[0-9]+\.([0-9]+)\.[0-9]+/\1/')
            LATEST_PATCH=$(echo $LATEST_VERSION | sed -E 's/v[0-9]+\.[0-9]+\.([0-9]+)/\1/')
            
            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒ
            if [ $MAJOR -lt $LATEST_MAJOR ] || 
               ([ $MAJOR -eq $LATEST_MAJOR ] && [ $MINOR -lt $LATEST_MINOR ]) || 
               ([ $MAJOR -eq $LATEST_MAJOR ] && [ $MINOR -eq $LATEST_MINOR ] && [ $PATCH -le $LATEST_PATCH ]); then
              echo "Error: Version $VERSION is not greater than latest version $LATEST_VERSION"
              exit 1
            fi
          fi
          
          echo "Version validation successful: $VERSION is newer than existing versions."

  # GitHubã‚¿ã‚°ä½œæˆã‚¸ãƒ§ãƒ–: validate-versionã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ãŸã‚‰ã€GitHubãƒªãƒã‚¸ãƒˆãƒªã«ã‚¿ã‚°ã‚’ä½œæˆã—ã¾ã™
  create-tag:
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—
      
      # ã‚¹ãƒ†ãƒƒãƒ—2: Gitãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
      - name: Setup git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      # ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¿ã‚°ã®ä½œæˆã¨ãƒ—ãƒƒã‚·ãƒ¥
      - name: Create and push tag
        run: |
          VERSION="${{ github.event.inputs.version }}"
          ANNOTATION="Frontend release $VERSION - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          echo "Creating annotated tag $VERSION with message: $ANNOTATION"
          git tag -a "$VERSION" -m "$ANNOTATION"
          git push origin "$VERSION"
          
          echo "Successfully created and pushed tag $VERSION"

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: create-tag
    environment: production
    permissions:
      id-token: write
      contents: read
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run tests
        run: |
          cd frontend
          npm test -- --watchAll=false

      - name: Build application
        run: |
          cd frontend
          REACT_APP_API_URL=${{ secrets.API_URL }} REACT_APP_VERSION=${{ github.event.inputs.version }} npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Tag production deployment
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Deploying frontend version: $VERSION"
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
          echo "{\"version\": \"$VERSION\", \"deployedAt\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\", \"commit\": \"${{ github.sha }}\"}" > frontend/build/version-$VERSION.json

      - name: Deploy to S3
        run: |
          aws s3 sync frontend/build/ s3://cicd-sample-frontend-prod/ --delete

      - name: Invalidate CloudFront cache
        run: |
          export CLOUDFRONT_DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?contains(Aliases.Items, 'cicd-sample-frontend-prod')].Id" --output text)
          aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"
      
      - name: Deployment completed
        run: |
          echo "ðŸš€ Frontend version ${{ env.VERSION }} has been successfully deployed to production environment." 