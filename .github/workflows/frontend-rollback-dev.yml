name: Frontend Manual Rollback (Development)

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯é–‹ç™ºç’°å¢ƒã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é…ç½®ç‰©ã‚’æ‰‹å‹•ã§å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™ãŸã‚ã®ã‚‚ã®ã§ã™
on:
  workflow_dispatch:
    inputs:
      version_to_rollback:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹: abc123-devï¼‰'
        required: true
        type: string
      confirm_rollback:
        description: 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ŒCONFIRMã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„'
        required: true
        type: string

jobs:
  validate-input:
    runs-on: ubuntu-latest
    steps:
      # ç¢ºèªå…¥åŠ›ãŒæ­£ã—ã„ã‹ã‚’æ¤œè¨¼
      - name: ç¢ºèªå…¥åŠ›ã®æ¤œè¨¼
        if: github.event.inputs.confirm_rollback != 'CONFIRM'
        run: |
          echo "ã‚¨ãƒ©ãƒ¼: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ 'CONFIRM' ã¨å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
          exit 1

  rollback:
    runs-on: ubuntu-latest
    needs: validate-input
    environment: development  # é–‹ç™ºç’°å¢ƒã«å¤‰æ›´
    permissions:
      id-token: write
      contents: read
    
    steps:
      # AWSèªè¨¼æƒ…å ±ã®è¨­å®š
      - name: AWSèªè¨¼æƒ…å ±ã®è¨­å®š
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      # åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è¦§è¡¨ç¤º
      - name: åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è¦§è¡¨ç¤º
        run: |
          echo "S3ãƒã‚±ãƒƒãƒˆå†…ã®åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™..."
          aws s3 ls s3://cicd-sample-frontend-dev/ --delimiter "/" | grep -v "current/" | grep -v "backup-" || echo "æ³¨æ„: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
      
      # æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      - name: æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
        run: |
          VERSION="${{ github.event.inputs.version_to_rollback }}"
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if aws s3 ls "s3://cicd-sample-frontend-dev/$VERSION/" --delimiter "/" 2>/dev/null; then
            echo "æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ $VERSION ã¯å­˜åœ¨ã—ã¾ã™"
            echo "VERSION_EXISTS=true" >> $GITHUB_ENV
          else
            echo "è­¦å‘Š: æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ $VERSION ã¯S3ãƒã‚±ãƒƒãƒˆã«å­˜åœ¨ã—ã¾ã›ã‚“"
            echo "åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã„ãšã‚Œã‹ã‚’é¸æŠã—ã¦ãã ã•ã„"
            echo "VERSION_EXISTS=false" >> $GITHUB_ENV
            exit 1
          fi
      
      # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆï¼ˆç¾åœ¨ã®currentãƒ•ã‚©ãƒ«ãƒ€ã®çŠ¶æ…‹ã‚’ä¿å­˜ï¼‰
      - name: ç¾åœ¨ã®currentãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        if: env.VERSION_EXISTS == 'true'
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "ç¾åœ¨ã®currentãƒ•ã‚©ãƒ«ãƒ€ã®çŠ¶æ…‹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™: backup-$TIMESTAMP/"
          
          # currentãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if aws s3 ls "s3://cicd-sample-frontend-dev/current/" --delimiter "/" 2>/dev/null; then
            # currentãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã‚’backupãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼
            aws s3 sync s3://cicd-sample-frontend-dev/current/ s3://cicd-sample-frontend-dev/backup-$TIMESTAMP/ --delete
            echo "backup-$TIMESTAMP/ ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ"
          else
            echo "currentãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi
      
      # currentãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã‚’æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ç½®ãæ›ãˆ
      - name: currentãƒ•ã‚©ãƒ«ãƒ€ã®æ›´æ–°
        if: env.VERSION_EXISTS == 'true'
        run: |
          VERSION="${{ github.event.inputs.version_to_rollback }}"
          echo "currentãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã‚’ãƒãƒ¼ã‚¸ãƒ§ãƒ³ $VERSION ã«ç½®ãæ›ãˆã¾ã™..."
          
          # æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰currentãƒ•ã‚©ãƒ«ãƒ€ã¸ã‚³ãƒ”ãƒ¼
          aws s3 sync s3://cicd-sample-frontend-dev/$VERSION/ s3://cicd-sample-frontend-dev/current/ --delete
          
          echo "currentãƒ•ã‚©ãƒ«ãƒ€ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ"
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’version.jsonã«ä¿å­˜
          echo "{\"version\": \"$VERSION\", \"rollback_date\": \"$(date --iso-8601=seconds)\", \"rollback_by\": \"github-actions\"}" > version.json
          aws s3 cp version.json s3://cicd-sample-frontend-dev/current/version.json --metadata-directive REPLACE
      
      # CloudFrontã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
      - name: CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç„¡åŠ¹åŒ–
        run: |
          echo "CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã„ã¾ã™..."
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
      
      # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å®Œäº†ã‚µãƒãƒªãƒ¼
      - name: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ã‚µãƒãƒªãƒ¼
        run: |
          echo "âœ… é–‹ç™ºç’°å¢ƒãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸ”„ currentãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ãŒãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${{ github.event.inputs.version_to_rollback }} ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ"
          echo "ğŸ§¹ CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ" 