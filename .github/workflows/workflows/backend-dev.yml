# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºç’°å¢ƒç”¨ã®CICDå‡¦ç†ã‚’å®šç¾©ã—ã¾ã™
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯é–‹ç™ºç’°å¢ƒï¼ˆdevelopï¼‰å‘ã‘ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ã€ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–ã—ã¾ã™
name: Backend Development Workflow

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ã‚’å®šç¾©
on:
  # developãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œï¼ˆbackendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ï¼‰
  push:
    branches:
      - develop
    paths:
      - 'backend/**'
  # developãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«å®Ÿè¡Œï¼ˆbackendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ï¼‰
  pull_request:
    branches:
      - develop
    paths:
      - 'backend/**'
  # æ‰‹å‹•å®Ÿè¡Œã®ãƒˆãƒªã‚¬ãƒ¼ã‚‚è¨­å®š
  workflow_dispatch:

# å¿…è¦ãªæ¨©é™ã‚’å®šç¾©
permissions:
  contents: read          # ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿å–ã‚Šæ¨©é™
  id-token: write         # OIDCèªè¨¼ç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆæ¨©é™
  pull-requests: read     # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæ¨©é™

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
env:
  AWS_REGION: ${{ secrets.AWS_REGION }}               # AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_DEV }}   # é–‹ç™ºç’°å¢ƒç”¨ECRãƒªãƒã‚¸ãƒˆãƒªå

jobs:
  # ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–: PRã®å ´åˆã®ã¿ã€ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
  check_branch_rules:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ã®ãƒã‚§ãƒƒã‚¯
      - name: Check source branch for protection rules
        id: branch-check
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã®å–å¾—
          SOURCE_BRANCH="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"
          
          echo "Source branch: $SOURCE_BRANCH"
          echo "Target branch: $TARGET_BRANCH"
          
          # developãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã¯feature/*ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ã¿è¨±å¯
          if [ "$TARGET_BRANCH" == "develop" ] && [[ ! "$SOURCE_BRANCH" =~ ^feature/.+ ]]; then
            echo "Error: Pull requests to develop branch must come from a feature branch (feature/*)."
            exit 1
          fi
          
          echo "Branch protection rules passed."

  # ãƒ†ã‚¹ãƒˆã¨ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ï¼†ECRã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’è¡Œã„ã¾ã™
  test-and-build:
    runs-on: ubuntu-latest
    # PRã®å ´åˆã¯ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸå¾Œã«å®Ÿè¡Œ
    needs: [check_branch_rules]
    # PRã§ãªã„å ´åˆã€ã¾ãŸã¯ä¸Šè¨˜ã®ã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ãŸå ´åˆã«å®Ÿè¡Œ
    if: always() && (github.event_name != 'pull_request' || needs.check_branch_rules.result == 'success')
    environment: development   # GitHub Environmentã§è¨­å®šã—ãŸã€Œdevelopmentã€ç’°å¢ƒã‚’ä½¿ç”¨
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}   # å¾Œç¶šã‚¸ãƒ§ãƒ–ã§åˆ©ç”¨ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã‚’å‡ºåŠ›

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3

      # ã‚¹ãƒ†ãƒƒãƒ—2: Rubyã®å®Ÿè¡Œç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'              # Rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®š
          bundler-cache: true              # Bundlerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–ï¼ˆé«˜é€ŸåŒ–ï¼‰
          working-directory: 'backend'     # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š

      # ã‚¹ãƒ†ãƒƒãƒ—3: Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run tests
        working-directory: backend
        run: |
          bundle exec rspec

      # ã‚¹ãƒ†ãƒƒãƒ—4: AWSèªè¨¼æƒ…å ±ã®è¨­å®šï¼ˆECRã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¿…è¦ï¼‰
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ã‚¹ãƒ†ãƒƒãƒ—5: Amazon ECRã¸ã®ãƒ­ã‚°ã‚¤ãƒ³
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # ã‚¹ãƒ†ãƒƒãƒ—6: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°ã‚’è¨­å®šï¼ˆ<git-hash>-devå½¢å¼ï¼‰
      - name: Set image tag
        id: image-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)    # ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã®å…ˆé ­7æ–‡å­—ã‚’å–å¾—
          TAG="${SHORT_SHA}-dev"                             # ã‚¿ã‚°ã‚’ã€Œ<git-hash>-devã€å½¢å¼ã§ä½œæˆ
          echo "tag=$TAG" >> $GITHUB_OUTPUT                  # ã‚¿ã‚°ã‚’å‡ºåŠ›å¤‰æ•°ã«è¨­å®š
          echo "ECR_REPOSITORY_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}" >> $GITHUB_ENV  # ECRãƒªãƒã‚¸ãƒˆãƒªURIã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š

      # ã‚¹ãƒ†ãƒƒãƒ—7: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
      - name: Build and push Docker image
        working-directory: backend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .    # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG          # ECRã«ãƒ—ãƒƒã‚·ãƒ¥
          echo "Image pushed to ECR: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      # ã‚¹ãƒ†ãƒƒãƒ—8: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRã®å ´åˆã®ã¿å®Ÿè¡Œï¼‰
      - name: Comment on PR with build info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Backend image built and pushed to ECR.\nCommit: ' + context.sha + '\nImage tag: ${{ steps.image-tag.outputs.tag }}'
            })

  # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–: ãƒ“ãƒ«ãƒ‰ã—ãŸDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ECSã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™
  deploy:
    runs-on: ubuntu-latest
    needs: test-and-build   # test-and-buildã‚¸ãƒ§ãƒ–ã®å®Œäº†å¾Œã«å®Ÿè¡Œ
    environment: development   # GitHub Environmentã§è¨­å®šã—ãŸã€Œdevelopmentã€ç’°å¢ƒã‚’ä½¿ç”¨

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3

      # ã‚¹ãƒ†ãƒƒãƒ—2: AWSèªè¨¼æƒ…å ±ã®è¨­å®š
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ã‚¹ãƒ†ãƒƒãƒ—3: Amazon ECRã¸ã®ãƒ­ã‚°ã‚¤ãƒ³
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
      - name: Set environment variables
        run: |
          echo "ECR_REPOSITORY_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ needs.test-and-build.outputs.image-tag }}" >> $GITHUB_ENV

      # ã‚¹ãƒ†ãƒƒãƒ—5: ç¾åœ¨ã®ECSã‚¿ã‚¹ã‚¯å®šç¾©ã‚’å–å¾—
      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition cicd-sample-task-dev \
            --query "taskDefinition" \
            --output json > task-definition.json

      # ã‚¹ãƒ†ãƒƒãƒ—6: ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã§æ›´æ–°
      - name: Update task definition with new image
        run: |
          # jqã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚¹ã‚¯å®šç¾©ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°
          jq --arg IMAGE "$ECR_REPOSITORY_URI:$IMAGE_TAG" \
             --arg VERSION "$IMAGE_TAG" \
             '.containerDefinitions[0].image = $IMAGE | .containerDefinitions[0].environment += [{"name": "APP_VERSION", "value": $VERSION}]' \
             task-definition.json > new-task-definition.json
          
          # æ›´æ–°ã—ãŸã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ç™»éŒ²
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --query "taskDefinition.taskDefinitionArn" \
            --output text)
          
          echo "New task definition registered: $NEW_TASK_DEF_ARN"
          echo "TASK_DEF_ARN=$NEW_TASK_DEF_ARN" >> $GITHUB_ENV

      # ã‚¹ãƒ†ãƒƒãƒ—7: ECSã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°ã—ã¦æ–°ã—ã„ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster cicd-sample-cluster-dev \
            --service cicd-sample-service-dev \
            --task-definition $TASK_DEF_ARN \
            --force-new-deployment

      # ã‚¹ãƒ†ãƒƒãƒ—8: ãƒ‡ãƒ—ãƒ­ã‚¤ã®å®Œäº†ã‚’å¾…æ©Ÿ
      - name: Wait for deployment to complete
        run: |
          aws ecs wait services-stable \
            --cluster cicd-sample-cluster-dev \
            --services cicd-sample-service-dev

      # ã‚¹ãƒ†ãƒƒãƒ—9: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRã®å ´åˆã®ã¿å®Ÿè¡Œï¼‰
      - name: Comment on PR with deployment info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ Backend deployed to development environment.\nCommit: ' + context.sha + '\nImage tag: ${{ env.IMAGE_TAG }}\nAPI URL: ${{ secrets.API_URL }}'
            }) 