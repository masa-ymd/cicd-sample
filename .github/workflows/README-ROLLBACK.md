# フロントエンドロールバックワークフロー

このドキュメントは、GitHub Actionsワークフローを使用してフロントエンドのデプロイメントを手動でロールバックする方法を説明します。

## 概要

ロールバックワークフローは主に2つのアクションを実行します：
1. 指定されたバージョンのフロントエンドアプリケーションを現在のアクティブバージョンとして設定
2. CloudFrontキャッシュを無効化し、ロールバックされたバージョンがユーザーに提供されるようにする

## 使用するタイミング

このワークフローは以下の場合に使用してください：
- 本番環境へのデプロイメントで重大なバグが発生した場合
- 以前の正常に動作していたバージョンに素早く戻す必要がある場合
- 通常のデプロイ手順では問題を修正するのに時間がかかりすぎる場合

## 前提条件

- ワークフローをトリガーする権限を持つGitHubアクセス
- フロントエンドアプリケーションがバージョン別ディレクトリに配置されていること
- S3バケット構造:
  ```
  s3://cicd-sample-frontend-[env]/
    ├── v1.0.0/           # バージョン1.0.0のビルド成果物
    ├── v1.1.0/           # バージョン1.1.0のビルド成果物
    ├── main-abc123/      # コミットハッシュなどに基づくバージョン
    ├── index.html        # 現在のアクティブバージョンのindex.html
    └── version.json      # 現在アクティブなバージョン情報
  ```

## デプロイ方法の変更が必要な理由

Reactなどのモダンフロントエンドフレームワークでは、ビルド時にJS/CSSファイルにハッシュ値が付与され（例：`main.a1b2c3d4.js`）、ビルドごとにファイル名が変わります。このため、個々のファイルバージョンを使用したロールバックでは正しく動作しないことがあります。

バージョン別ディレクトリ構造でデプロイすることで、各バージョンを完全に分離して管理し、簡単にロールバックできるようになります。

## デプロイ設定の更新

デプロイワークフローも以下のように更新する必要があります：

```yaml
# デプロイ時に使用するコマンド例
VERSION="v1.2.3" # または ${GITHUB_SHA} など
# バージョンディレクトリにデプロイ
aws s3 sync frontend/build/ s3://cicd-sample-frontend-prod/$VERSION/ --delete
# ルートインデックスを更新
aws s3 cp s3://cicd-sample-frontend-prod/$VERSION/index.html s3://cicd-sample-frontend-prod/index.html
# バージョン情報を記録
echo "{\"version\": \"$VERSION\", \"deploy_date\": \"$(date --iso-8601=seconds)\"}" > version.json
aws s3 cp version.json s3://cicd-sample-frontend-prod/version.json
```

## ロールバックの実行方法

1. GitHubリポジトリのActionsタブに移動
2. リストから「Frontend Manual Rollback (Production)」または「Frontend Manual Rollback (Development)」ワークフローを選択
3. 「Run workflow」をクリック
4. パラメータを入力：
   - **ロールバックするバージョン**: ロールバックしたいバージョンのディレクトリ名（例: v1.2.3, main-abc123など）
   - **ロールバック確認**: ロールバックを実行するには「CONFIRM」（大文字）と入力
5. 「Run workflow」をクリックしてロールバックプロセスを開始

## 利用可能なバージョンの確認方法

ロールバックできるバージョンは、S3バケット内のディレクトリで確認できます：

```bash
aws s3 ls s3://cicd-sample-frontend-prod/ --delimiter "/"
```

または、ワークフロー実行時に最初のステップで利用可能なバージョンのリストが表示されます。

## トラブルシューティング

- ロールバックが失敗した場合、ワークフローログで具体的なエラーメッセージを確認
- 指定したバージョンが存在しない場合はエラーとなります
- AWS認証情報が正しく設定されていることを確認
- CloudFrontの無効化が失敗した場合は、AWSコンソールで手動で無効化を作成することもできます 